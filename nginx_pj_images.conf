events {
        worker_connections 1024;
}
http {
    server_tokens off;
    charset utf-8;
    client_max_body_size 75M;
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # always redirect to https
    server {
        listen 80 default_server;
        server_name _;
        return 301 https://$host$request_uri;
    }

    server {
        listen 443 ssl http2;
        ssl_certificate     /etc/letsencrypt/live/www.pj-images.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/www.pj-images.com/privkey.pem;
        server_name www.pj-images.com;
        root /var/www/html;
        index index.php index.html index.htm;

        location / {
            proxy_pass http://www.pj-images.com:8001;
        }

        location /songs {
           proxy_pass http://www.pj-images.com:9080;
        }

        # Blog API - REMOVED CORS headers, let FastAPI handle them
        location /blog/api/ {
           proxy_pass http://www.pj-images.com:3001/api/;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_set_header X-Forwarded-Proto $scheme;

           # Handle OPTIONS requests
           if ($request_method = 'OPTIONS') {
                return 204;
           }
        }

        # Blog docs access
        location /blog/docs {
           proxy_pass http://www.pj-images.com:3001/docs;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Blog OpenAPI JSON
        location /blog/openapi.json {
           proxy_pass http://www.pj-images.com:3001/openapi.json;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Blog WebSocket for development
        location /blog/ws {
           proxy_pass http://www.pj-images.com:3080/ws;
           proxy_http_version 1.1;
           proxy_set_header Upgrade $http_upgrade;
           proxy_set_header Connection "Upgrade";
           proxy_set_header Host $host;
        }

        # Blog frontend static files
        location /blog/static/ {
           proxy_pass http://www.pj-images.com:3080/static/;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Blog frontend
        location /blog/ {
           proxy_pass http://www.pj-images.com:3080/;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Blog root redirect
        location = /blog {
            return 301 /blog/;
        }

	# make /games redirect consistently to /games/ so relative paths behave predictably
	location = /games {
    	    return 301 /games/;
	}

	# Serve the runner under /games/
	location /games/ {
    	   # trailing slash on proxy_pass strips /games/ and forwards remainder to upstream
    	   # (so /games/assets/... -> upstream /assets/...)
    	   proxy_pass http://www.pj-images.com:2001;

    	   # preserve some useful headers
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_set_header X-Forwarded-Proto $scheme;

           # IMPORTANT: tells the upstream it is mounted under /games/
           proxy_set_header X-Forwarded-Prefix /games/;

           # keep-alive & buffering tweaks - optional, but commonly useful
           proxy_http_version 1.1;
           proxy_set_header Connection "";
        }

        
	location /api {
           proxy_pass http://www.pj-images.com:5001;
        }

        location ~ (/small|/medium|/large) {
           proxy_pass http://www.pj-images.com:8080;
        }

        location ~ (/admin|/reload|/auth|/challenge|/logout) {
           proxy_pass http://www.pj-images.com:5000;
        }

        location /js {
            proxy_pass http://www.pj-images.com:5000;
        }

        location /css {
            proxy_pass http://www.pj-images.com:5000;
        }

        location ~ /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }
    }
}
